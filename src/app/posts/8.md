---
title: "APIについて"
date: "2024-10-21"
tags: ["api", "参考書"]
description: "Web API: The Good Parts 水野貴明(著)"
id: "8"
---
## はじめに
今回は、[水野貴明 著 「Web API: The Good Parts」（オライリー・ジャパン発行）]((https://www.amazon.co.jp/Web-API-Parts-%E6%B0%B4%E9%87%8E-%E8%B2%B4%E6%98%8E/dp/4873116864/ref=sr_1_1?adgrpid=121602143400&dib=eyJ2IjoiMSJ9.qomneTPaBkx3YarwtCXe8dxkofcKkBz2m_YjGnY6Kk3ZqTCNhBUxAexeVXAmPVLr6sg4iT_e1tXlKz1Bx1_tB5NY1kGSJlF5YiPZyh89Mj6i41HxVMOTUv8A-L43tlt5bgnRLvgXtnzvWOrx58KhBDsJdBvnXr82MD-Zx5OC_WN3WEKe4j2JTayQLS8oxTuTa8Iiv8PmcMT_JRC_kjHSMZCsXKlBM7SSdCMi02m8TpQ0JPeh3j6lQk7fcBJwjw1EWBAMIhWx42GJeogPFyfpN8lGJavx6CWYIqLYMUZk6hw.dvJ76576aUDsQ1Yd32laCm_0SNLUUw74ZjwP0X3hp0k&dib_tag=se&hvadid=699038462109&hvdev=c&hvqmt=e&hvtargid=kwd-525626072592&hydadcr=27296_14768183&jp-ad-ap=0&keywords=web+api+the+good+parts&qid=1729491483&sr=8-1))について得た知識を紹介しようと思います。

## RESTについて
----
現在、RESTは「REST API」という言葉で使われています。この言葉は2種類の意味として使われています。
1. FieldingのRESTアーキテクチャスタイルの原則に合わせたウェブサービスシステム
2. RPC(Remote Procedure Call)スタイルに合わせた簡易なXML(やJSON)とHTTPインターフェースを採用したシステム
RESTとは、簡単に言うとシンプルなWebシステムの設計思想のことです。これを守ることで、情報をやり取りする際に問題なく連携できるというような意味合いです。

## エンドポイントの設計
----
WebAPIによるエンドポイントとは、APIにアクセスするためのURIのことを指します。

### エンドポイント作成の注意点
WebAPIにおけるエンドポイントはURIであり、クライアントから見てどんな機能を持つかひと目でわかるようにする必要があります。以下にそのポイントを挙げます。
1. 短く簡潔
2. よく使われる英単語を使う
3. 大文字小文字が混在していない（小文字で統一）
4. 改造しやすい
5. サーバ側のアーキテクチャが反映されていない
6. ルールが統一されている
以下にそれぞれ説明したいと思います。

#### 1. 短く簡潔
エンドポイントを作成する際は、冗長にならないようにする必要があります。
<br/>

#### 2. よく使われる英単語を使う
クライアントから見て、例えばスペイン語などがURIに含まれていたらひと目で判断できなくなる可能性があります。また、英語圏では略される言葉であっても基本的には略さずに設計したほうが良いです。ただし、japanがjpのように、略語が標準化されているものに関しては積極的に略語を使ったほうが良いです。
<br/>

#### 3. 大文字小文字が混在していない（小文字で統一）
URIの中にアルファベットの大文字や小文字が混在していると、APIがわかりずらくなり、間違えやすくなります。その場合標準的に選択されているのは小文字です。
例えばgetUserNameのような場合は、get_user_nameとすることもできますが、そもそもこういった名前の付け方は良くないみたいです。どうしても単語をつなげたい場合はハイフン(-)を利用することが一般的です。また、単語は複数形で利用するべきです。
<br/>

#### 4. 改造しやすい
改造しやすい(Hackable)URIは、エンドポイントを見て他のエンドポイントを想像できるように設計するということです。例えば、
```html
http://api.example.com/v1/items/123456
```
のようなURIは直感的にIDが123456であるということが予想できます。クライアントからみて、APIを使うのに毎回ドキュメントを見なければならないのはストレスがかかります。
<br/>

#### 5. サーバ側のアーキテクチャが反映されていない
クライアント側から見て、サーバ側でのアーキテクチャは全く必要のない情報です。例えば、
```html
http://api.example.com/cgi-bin/get_user.php?user=100
```
のようなURIではサーバがphpで書かれていることがすぐに判明してしまいます。これらは、サーバの脆弱性を突いてくる人たちにとっても有益な情報を与えることになってしまうため、良くないといえます。
<br/>

#### ルールが統一されている
WebAPIを提供する場合、ほとんどの場合で複数のAPIを公開します。例えば、
```html
// 友達の情報の取得
http://api.example.com/friends?id=100

// メッセージの投稿
http://api.example.com/friend/100/message
```
これら２つのAPIが同一のサービスであった場合、クライアントが実装する際に混乱を招いてしまいます。ゆえに、エンドポイントを作成する際はルールを統一しておいたほうがわかりやすいということです。

### HTTPメソッド
APIのエンドポイントとHTTPのメソッドは切っても切れない関係にあります。以下の表はURIが「何をするか」を表すHTTPメソッドです。
| メソッド名 | 説明                     |
|------------|--------------------------|
| GET        | リソースの取得            |
| POST       | リソースの新規登録        |
| PUT        | 既存リソースの更新        |
| DELETE     | リソースの削除            |
| PATCH      | リソースの一部変更        |
| HEAD       | リソースのメタ情報の取得  |

#### PATCHとPUTの違い
PUTはもともとのリソースを置き換える役割を持つのに対し、、PATCHはその一部だけを更新したい場合に使います。例えば、1MBもあるようなデータのごく一部を更新したい場合は、PATCHを用いればいいのです。

#### X-HTTP-Method-Overrideヘッダ
HTTPメソッドのうち、GETとPOSTは昔から存在していましたが、現在は他のメソッドも新しく追加されています。その際、例えばクライアント開発時に利用しているライブラリがGETやPOSTのみに対応している場合、他のメソッドは利用できなくなってしまいます。そういった場合を考慮してX-HTTP-Method-Overrideリクエストが使われます。このリクエストは、POSTメソッドに対して、実際に利用したいメソッドをヘッダ内に記述するために利用します。
```html
POST /v1/users/123 HTTP/1.1
Host: api.example.com
X-HTTP-Method-Override: DELETE //ここで定義
```

### クエリパラメータの設計
クエリパラメータとは、URIに対して?の後ろにつけることができるパラメータのことです。クエリパラメータはFormをGETで送信する際にも利用されます。たくさんあるデータの一部を取得する際にどういったパラメータで取得数と取得位置を指定するかを決めます。これはページネーションを実現するためのもので、SQLのSELECT文でいえばlimitとoffsetで指定する数値です。これは各種APIによってまちまちです。<br/>
一般的には取得数にlimit, per_page, 取得位置にoffset, pageが用いられています。pageはper_page単位で1ページ、2ページと数えますが、offsetの場合はアイテム単位で数えます。例えば1ページ50アイテムの場合、3ページ目は101アイテム目からになります。
```html
per_page=50&page=3 \\1ページ50アイテムで3ページ目を取得
limit=50&offset=100 \\1ページ50アイテムの時101アイテム目から50アイテム分取得
```
この際、pageは1から、offsetは0から数え始めるのが一般的です。

#### 相対位置と絶対位置
あるデータを取得するための指定方法として、相対位置で指定する場合と絶対位置で指定する2つの方法があります。この場合、取得位置の指定方法として絶対位置を利用することをお勧めします。<br/>
相対位置の欠点として、データ数が多くなると必然的にデータ取得にかかる時間が長くなります。また、更新頻度の高いデータにおいてデータに不整合が生じる可能性もあります。これは、例えば20件のデータを取得してから次の20件のデータを取得する間にデータの更新が入ってしまった場合、実際に取得したい情報と取得された情報にずれが生じてしまうためです。<br/>
それに対して、絶対位置は指定したIDよりも前(max_id)、あるいは指定した日時よりも前に、という指定方法ができます。これにより更新の頻度やデータの量を気にしなくて済むようになります。<br/>

### ホスト名とエンドポイントの共通部分
エンドポイントを構成するURIにはapiという単語が使われることが多いです。
その中で最も主流なのがホスト名にapiが含まれたapi.example.comです。